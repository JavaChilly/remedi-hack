<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Google Maps JavaScript API v3 Example: Place Search</title>
    <script src="https://maps.googleapis.com/maps/api/js?sensor=true&libraries=places"></script>
	<script src="http://jqueryjs.googlecode.com/files/jquery-1.2.6.min.js"></script>
	
    <style>
      #map {
        height: 205px;
        width: 310px;
        border: 1px solid #333;
        margin-top: 0.6em;
      }
    </style>

    <script>
      var map;
      var infowindow;
	  var IDs = new Array();
	  var provider = 'Cheap+Medical';
	  var jsonObj = [];

      function initialize() {
        
		if (navigator.geolocation) {
        	navigator.geolocation.getCurrentPosition(function(position){
				//var latitude = position.coords.latitude;
				var latitude  = 34.101708;
        		//var longitude = position.coords.longitude;
				var longitude = -118.344324;
				var hollywood = new google.maps.LatLng(latitude, longitude);

        		map = new google.maps.Map(document.getElementById('map'), {
          			mapTypeId: google.maps.MapTypeId.ROADMAP,
		        	center: hollywood,
          			zoom: 14
        		});

	        	var request = {
	          		location: hollywood,
	          		radius: 1000,
	          		types: ['doctor']
	        	};
		
				var marker = new google.maps.Marker({
					map: map,
					position: hollywood,
					icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
				});
		
				google.maps.event.addListener(marker, 'click', function() {
		          infowindow.setContent("Your location.");
		          infowindow.open(map, this);
				  //THIS IS WHERE WE CALL OUR SHIT
		        });
		
        		infowindow = new google.maps.InfoWindow();
        		
				var service = new google.maps.places.PlacesService(map);
        		service.search(request, callback);
      		});

	  	}else{
			alert("Your browser sucks- can't geolocate.");
	  	}
	
	  }
	  
      function callback(results, status) {
      	if (status == google.maps.places.PlacesServiceStatus.OK) {
		  
		  var locations = {};
          for (var i = 0; i < results.length; i++) {
            // put the ids in a flat array for filtering
	    	IDs[i] = results[i].id;
		    // store the locations in a hashmap, so we can place markers later
		    locations[results[i].id] = results[i];
          }
          
		  console.log(IDs);

          $.ajax({
        	url: '/test/places/doctor/filter/',
	        type: 'POST',
	        data: 'doctorContent='+JSON.stringify({ids:IDs})+'&provider='+provider,
        	contentType: "application/x-www-form-urlencoded",
			dataType: "json",
        	success : function (filteredMatches) {
            	for ( var i = 0; i < filteredMatches.length; i++) {
					var match = filteredMatches[i];
					createMarker(match, locations[match.id]);
				}
				console.log(jsonObj);
	  			console.log("Great success!");
        	}
	  	  });
        }
      }

      function createMarker(details, place) {
        var placeLoc = place.geometry.location;
        var marker = new google.maps.Marker({
          map: map,
          position: place.geometry.location
        });

        google.maps.event.addListener(marker, 'click', function() {
		  $('#details').html([
			  formatDetail('Name', details.name),
			  formatDetail('Gender', details.gender),
			  formatDetail('Languages', details.languages),
			  formatDetail('Specialties', details.specialties),
			  formatDetail('Accepting Patients', details.acceptingNew ? 'Yes' : 'No'),
			  formatDetail('Board Certified', details.boardCertified ? 'Yes' : 'No'),
			  formatDetail('Affiliation', details.affiliation)
			].join(""));
			
          //infowindow.setContent(place.name);
          //infowindow.open(map, this);
        });
      }

	  function formatDetail(label, value) {
		return [
		'<div class="detail">',
		'<div class="label">', label, '</div>',
		'<div class="value">', (typeof value == "object" ? value.join(', ') : value), '</div>',
		'</div>'
		].join('');
	  }
	  
      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
	<div><b>Doctors Near You</b></div>
    <div id="map"></div>
    <div id="details">
	
    </div>
  </body>
</html>
